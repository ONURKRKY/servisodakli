<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Canlı Döviz Kuru</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 50px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
      }
      .rate-box {
        display: inline-block;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        margin-top: 20px;
      }
      .value {
        font-size: 1rem;
        color: green;
        font-weight: bold;
      }
      .date {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h2>Faiz Hesaplama</h2>
    <div class="card">
      Anapara (₺) :
      <input type="number" id="principal" value="10000" /><br /><br />
      Faiz Oranı (%) :
      <input type="number" id="interest" value="12" /><br /><br />
      Vade (Ay) : <input type="number" id="months" value="12" /><br /><br />

      <button id="grpcCalculate">gRPC Hesapla</button>
      <div id="result" style="margin-top: 10px"></div>
    </div>



  <hr style="border: 0; border-top: 2px dashed #666; width: 60%; margin: 16px auto;">



    <h2> Döviz Kur Hesaplama</h2>
    <div class="card">
      <div class="value" id="rate"></div>
      <div class="date" id="date"></div>

      <button id="btn">Kur Bilgisi Güncelle</button>
     
    </div>


  <hr style="border: 0; border-top: 2px dashed #666; width: 60%; margin: 16px auto;">


    <script>
      // gRPC toplam ödemesini saklayacak global değişken
      let toplamodenen = 0;

      document
        .getElementById("grpcCalculate")
        // inputlardan değerler alındı
        .addEventListener("click", async () => {
          const principal = Number(document.getElementById("principal").value);
          const interest = Number(document.getElementById("interest").value);
          const months = Number(document.getElementById("months").value);
          //inputlar boş mu kontrol edildi, boş ise uyarı verilip, sonlandırıldı
          if (!principal || !interest || !months) {
            alert("Tüm değerleri girin!");
            return;
          }

          // //fetch → tarayıcıdan sunucuya HTTP isteği atar.
          const response = await fetch(
            `/calculate?principal=${principal}&interest=${interest}&months=${months}`
          );

          // response → sunucudan dönen yanıt (JSON, text veya başka bir şey olabilir).
          // await → cevap gelene kadar bekler (asenkron).
          const data = await response.json();

          // dönen response dataiçine alındı, eğer data ile error gelirse, html sayfasında yazdırılqacak
          if (data.error) {
            document.getElementById("result").innerText = "Hata: " + data.error;
            return;
          }

          if (!data.payments || !Array.isArray(data.payments)) {
            document.getElementById("result").innerText =
              "Ödeme tablosu alınamadı";
            return;
          }

          let html = `<table border="1" style="margin:auto"><tr><th>Ay</th><th>Ana Para</th><th>Faiz</th><th>Toplam Ödeme</th></tr>`;
          data.payments.forEach((p) => {
            html += `<tr>
            <td>${p.month}</td>
            <td>${p.principal.toFixed(2)}</td>
            <td>${p.interestAmount.toFixed(2)}</td>
            <td>${p.totalPayment.toFixed(2)}</td>
          </tr>`;
          });

          toplamodenen = data.totalPayment;

          html += `<tr><td colspan="3"><b>Toplam</b></td><td><b>${data.totalPayment.toFixed(
            2
          )}</b></td></tr>`;
          html += `</table>`;

          document.getElementById("result").innerHTML = html;
        });




        ////// soket bağlantısı buradan başlıyor

        ///"ws://127.0.0.1:3000" websoket protokolünü kullanıyor, html protokolü değil,sürekli açık
        /// backend de bağlanıp, sürekli bağlı kalacak, express varsayılan port 3000
        const ws=new WebSocket("ws://127.0.0.1:3000");

        // bağlantı gerçekleştiğinde, yani el sıkışıldığında, çalışacak fonksiyon
        ws.onopen=()=>{
          console.log("soket bağlantısı sağlandı");          
        }

        //karşıdan backenden mesaj geldiğinde
        ws.onmessage=(event)=>{
          //JSON.parse strin olarak yapısı jsona benzeyen değeri json hale getirir.
          const data=JSON.parse(event.data);
          if(data.rate){

            // karşıdan data içinde rate değeri geldi, ve yüzdelikli halde inner texte yazıldı
            //`${}  `  bu kullanım text içine değer atmak için kullanılır.(rate.toFixed(2) + " ₺";) ile aynı işe yarar. yani string toplama
            document.getElementById("rate").innerText=`${data.rate.toFixed(2)}`;
          // karşıdan data içinde date değeri geldi, ve   inner texte yazıldı
            document.getElementById("date").innerText=data.date;

          }
        }
        // bağlantı koparsa çağrıacak callback
        ws.onclose=()=>{
          console.log("soket bağlantısı koptu");
          document.getElementById("rate").innerText="Soket bağlantısı koptu";
          
        }

        //butona tıklanınca
        document.getElementById("btn").addEventListener("click",()=>{

              //ws.readyState → WebSocket bağlantısının mevcut durumunu döndürür.
              // WebSocket.OPEN → bağlantının açık (aktif) durumda olduğunu belirtir.
          if(ws.readyState===WebSocket.OPEN){
            //karsıya getRate mesajı gönderiyor, yani string
            ws.send("getRate");
          } else{
            document.getElementById("rate").innerText="bağlı değil";
          }
        })

    </script>
  </body>
</html>
